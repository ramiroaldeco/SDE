<<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vot√° tu monigote favorito</title>
  <style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;

    /* Imagen de fondo */
    background: url("CRONOGRAMA.png") no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
  }

  h1 { color:#dc3626; margin:10px 0 20px; text-align:center; }
  .option { background:#fff; border-radius:10px; padding:12px 16px; margin:8px 0; width:320px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.08);}
  button { background:#f32f78; color:#fff; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
  button:disabled { background:#bbb; cursor:default; }
  .results { margin-top:20px; width:320px; background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,.08);}
  .row { display:flex; justify-content:space-between; align-items:center; margin:8px 0;}
  .bar { height:10px; border-radius:6px; background:#eee; overflow:hidden; }
  .fill { height:100%; width:0%; background:#f32f78; }
  small { color:#666; }
</style>
</head>
<body>

  <div id="options"></div>

  <div class="results">
    <h2 style="margin:0 0 10px;color:#f32f78;">Resultados en vivo</h2>
    <div id="results"></div>
    <small id="total"></small>
  </div>

<script>
const API = "https://sde-x3c3.onrender.com";
const RESET_KEY = "votos_reset_at"; // versi√≥n de reset que anuncia el server

// Ajust√° si agreg√°s 6¬∞/7¬∞ y/o IPET/IST extra
const OPTIONS = [
  "PRIMER A√ëO IST","SEGUNDO A√ëO IST","TERCER A√ëO IST",
  "CUARTO A√ëO IST","CUARTO A√ëO IPET",
  "QUINTO A√ëO IST","QUINTO A√ëO IPET"
];
const BASICO     = ["PRIMER A√ëO IST","SEGUNDO A√ëO IST","TERCER A√ëO IST"];
const ORIENTADO  = OPTIONS.filter(o => !BASICO.includes(o)); // el resto

const optionsEl = document.getElementById("options");
const resultsEl = document.getElementById("results");
const totalEl   = document.getElementById("total");

// ------- ID de cliente (1 por dispositivo) -------
const CLIENT_KEY = "votos_client_id";
let clientId = localStorage.getItem(CLIENT_KEY);
if (!clientId) {
  clientId = crypto.randomUUID(); // tambi√©n podr√≠as pedirlo al server: /new-client-id
  localStorage.setItem(CLIENT_KEY, clientId);
}

// ------- Flags por ciclo -------
const VOTED_BASICO_KEY     = "votos_ya_voto_basico";
const VOTED_ORIENTADO_KEY  = "votos_ya_voto_orientado";
let yaVotoBasico    = localStorage.getItem(VOTED_BASICO_KEY) === "true";
let yaVotoOrientado = localStorage.getItem(VOTED_ORIENTADO_KEY) === "true";

// Render de opciones
function renderOptions() {
  optionsEl.innerHTML = "";
  OPTIONS.forEach(opt => {
    const div  = document.createElement("div");
    div.className = "option";
    const span = document.createElement("span");
    span.textContent = opt;
    const btn  = document.createElement("button");
    btn.textContent = "Votar";

    const esBasico = ["PRIMER A√ëO IST","SEGUNDO A√ëO IST","TERCER A√ëO IST"].includes(opt);
    btn.disabled = esBasico ? yaVotoBasico : yaVotoOrientado;

    btn.onclick = () => votar(opt, esBasico);
    div.append(span, btn);
    optionsEl.appendChild(div);
  });
}

// Votar
async function votar(option, esBasico) {
  try {
    const res = await fetch(API + "/vote", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ option, clientId })
    });
    const data = await res.json();

    if (!res.ok) {
      alert(data.error || "No se pudo votar.");
      return;
    }

    if (esBasico) {
      yaVotoBasico = true;
      localStorage.setItem(VOTED_BASICO_KEY, "true");
    } else {
      yaVotoOrientado = true;
      localStorage.setItem(VOTED_ORIENTADO_KEY, "true");
    }

    renderOptions();
    await cargarResultados();
    alert("¬°Gracias por votar!");
  } catch (e) {
    alert("Error de conexi√≥n.");
  }
}

// Resultados
function rowTemplate(opt, pct, count) {
  const wrap = document.createElement("div");
  wrap.className = "row";
  const left = document.createElement("div");
  left.textContent = opt;
  const right = document.createElement("div");
  right.textContent = `${pct}% (${count})`;
  const bar = document.createElement("div");
  bar.className = "bar";
  const fill = document.createElement("div");
  fill.className = "fill";
  fill.style.width = pct + "%";
  bar.appendChild(fill);
  const container = document.createElement("div");
  container.style.width = "100%";
  container.appendChild(bar);

  const line = document.createElement("div");
  line.style.display = "grid";
  line.style.gridTemplateColumns = "1fr auto";
  line.style.gap = "8px";
  line.style.alignItems = "center";
  line.append(left, right);

  const outer = document.createElement("div");
  outer.append(line, container);
  return outer;
}

async function cargarResultados() {
  try {
    const res = await fetch(API + "/results");
    const data = await res.json();

    // üîë Detectar reseteo global anunciado por el server (igual que antes)
    const ultimoResetGuardado = localStorage.getItem(RESET_KEY);
    if (data.resetAt && data.resetAt !== ultimoResetGuardado) {
      localStorage.setItem(RESET_KEY, data.resetAt);
      localStorage.removeItem(VOTED_BASICO_KEY);
      localStorage.removeItem(VOTED_ORIENTADO_KEY);
      yaVotoBasico = false;
      yaVotoOrientado = false;
      renderOptions();
    }
    if (data.total === 0) {
      localStorage.removeItem(VOTED_BASICO_KEY);
      localStorage.removeItem(VOTED_ORIENTADO_KEY);
      yaVotoBasico = false;
      yaVotoOrientado = false;
      renderOptions();
    }

    // --- Render de resultados por grupo ---
    resultsEl.innerHTML = "";

    const titulo = (txt) => {
      const h = document.createElement("h3");
      h.textContent = txt;
      h.style.margin = "12px 0 8px";
      h.style.color = "#333";
      return h;
    };

    const renderGrupo = (nombre, opcionesGrupo) => {
      const grupoTotal = opcionesGrupo
        .map(opt => data.counts[opt] ?? 0)
        .reduce((a,b)=>a+b,0);

      resultsEl.appendChild(titulo(nombre));

      opcionesGrupo.forEach(opt => {
        const count = data.counts[opt] ?? 0;
        const pct = grupoTotal ? +((count*100)/grupoTotal).toFixed(1) : 0;
        resultsEl.appendChild(rowTemplate(opt, pct, count));
      });
    };

    // Ciclo B√°sico
    renderGrupo("Votos Ciclo B√°sico ", BASICO);
    // Ciclo Orientado
    renderGrupo("Votos Ciclo Orientado", ORIENTADO);

    // Pod√©s dejar el total general debajo si quer√©s
    totalEl.textContent = `Total de votos: ${data.total}`;
  } catch {}
}
// refresco cada 2 segundos para ‚Äútiempo real‚Äù
setInterval(cargarResultados, 2000);

renderOptions();
cargarResultados();
</script>
</body>
</html>


